// This is your test secret API key.
const stripe = require("stripe")(process.env.STRIPE_SECRET_KEY, {
  apiVersion: '2020-08-27; orders_beta=v4'
});

// const calculateOrderAmount = (items) => {
//   // Replace this constant with a calculation of the order's amount
//   // Calculate the order total on the server to prevent
//   // people from directly manipulating the amount on the client
//     let total = 0;
//     items.forEach(item => {
//         console.log(items)
//         total += (item.price * 100) * item.quantity;
//     })
//     console.log(total)
//   return total;
// };

// const getOrderDetails = (items) => {
//     let details = [];
//     items.forEach(item => {
//         details.push(`${item.name}: ${item.quantity}; `)
//     })
//     console.log(details)
//     return details.join(',');
   
// }

export default async function handler(req, res) {
    const { items, address } = req.body;
    console.log('you are in orders');
 //   console.log(items)


    const order = await stripe.orders.create({
	currency: 'eur',
	line_items: items,
// Replace this with checkout form input from the request
    shipping_details: {
      name: address.name,
      address: {
	line1: address.line1,
          line2: address.line2,
        city: address.city,
//        state: 'HE',
        postal_code: address.zip,
        country: address.country,      },
    },
    automatic_tax: {enabled: true},
    });

  // Create a PaymentIntent with the order amount and currency
  // const paymentIntent = await stripe.paymentIntents.create({
  //   amount: calculateOrderAmount(items),
  //   currency: "usd",
  //   automatic_payment_methods: {
  //     enabled: true,
  //   },
  //     shipping: {
  //         address: {
  //             city: address.city,
  //             country: address.country,
  //             line1: address.line1,
  //             line2: address.line2,
  //             postal_code: address.zip,
  //             state: address.state
  //         },
  //         name: address.name
  //     },
  //     description: getOrderDetails(items),
  //     receipt_email: address.email
  // });

  res.send({
    clientSecret: order.client_secret,
  });
};
